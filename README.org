#+TITLE: Características dos surdos de Campinas e região e seu acesso à saúde
#+SUBTITLE: Análise estatística das respostas do questionário online
#+AUTHOR: Janaina de Rezende Barreto e Rafael Rodrigues de Moraes
#+DATE: Setembro/2021
#+STARTUP: inlineimages showall
#+LANGUAGE: pt
#+OPTIONS: H:3 num:t toc:t @:t \n:nil ::t |:t ':t ^:nil f:t *:t TeX:t LaTeX:t
#+OPTIONS: date:t author:t

#+BEGIN_SRC elisp :results silent :exports none
;; exporta html como um arquivo só
;; Fonte: https://www.reddit.com/r/orgmode/comments/7dyywu/creating_a_selfcontained_html/
(defun org-html--format-image (source attributes info)
  (format "<img src=\"data:image/%s;base64,%s\"%s />"
		  (or (file-name-extension source) "")
		  (base64-encode-string
		   (with-temp-buffer
			 (insert-file-contents-literally source)
			 (buffer-string)))
		  (file-name-nondirectory source)))

#+END_SRC

* Configurações

** Pacotes do GNU R necessários para as análises

   Os seguintes pacotes do GNU R são necessários para executar as análises estatísticas presentes nas seções seguintes.

   #+BEGIN_SRC R :exports code :results silent :session 
   library(ggplot2)    # ggplot, geom_dotplot, geom_line ...
   library(readr)      # read_csv
   library(dplyr)      # %>%
   library(tidyr)      # pivot_longer
   library(stringr)    # str_sub
   library(xtable)     # xtable
   library(haven)      # write_sav
   #+END_SRC

** Ambiente de computação
   
   Com o intuito de facilitar a reproducibilidade dos resultados presentes no TCC, exibimos a seguir as versões do 

   Sistema Operacional
   #+begin_src sh :exports both :results output
   hostnamectl | tail -3
   #+end_src

   #+RESULTS:
   :   Operating System: Linux Mint 20.2
   :             Kernel: Linux 5.4.0-81-generic
   :       Architecture: x86-64
   
   e do software estatístico primário 
   #+begin_src R :exports both :results output :session
   sessionInfo()
   #+end_src

   #+RESULTS:
   #+begin_example
   R version 3.6.3 (2020-02-29)
   Platform: x86_64-pc-linux-gnu (64-bit)
   Running under: Linux Mint 20.2

   Matrix products: default
   BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
   LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0

   locale:
	[1] LC_CTYPE=pt_BR.UTF-8       LC_NUMERIC=C              
	[3] LC_TIME=pt_BR.UTF-8        LC_COLLATE=pt_BR.UTF-8    
	[5] LC_MONETARY=pt_BR.UTF-8    LC_MESSAGES=pt_BR.UTF-8   
	[7] LC_PAPER=pt_BR.UTF-8       LC_NAME=C                 
	[9] LC_ADDRESS=C               LC_TELEPHONE=C            
   [11] LC_MEASUREMENT=pt_BR.UTF-8 LC_IDENTIFICATION=C       

   attached base packages:
   [1] stats     graphics  grDevices utils     datasets  methods   base     

   other attached packages:
   [1] haven_2.4.0   xtable_1.8-4  stringr_1.4.0 tidyr_1.1.2   dplyr_1.0.3  
   [6] readr_1.4.0   ggplot2_3.3.3

   loaded via a namespace (and not attached):
	[1] magrittr_2.0.1   hms_1.0.0        tidyselect_1.1.0 munsell_0.5.0   
	[5] colorspace_2.0-0 R6_2.5.0         rlang_0.4.11     fansi_0.4.2     
	[9] blob_1.2.1       tools_3.6.3      grid_3.6.3       gtable_0.3.0    
   [13] utf8_1.2.1       DBI_1.1.1.9000   withr_2.4.2      ellipsis_0.3.2  
   [17] assertthat_0.2.1 tibble_3.1.1     lifecycle_1.0.0  crayon_1.4.1    
   [21] purrr_0.3.4      vctrs_0.3.8      glue_1.4.2       stringi_1.5.3   
   [25] compiler_3.6.3   pillar_1.6.0     forcats_0.5.1    generics_0.1.0  
   [29] scales_1.1.1     pkgconfig_2.0.3
   #+end_example

   no qual as análises foram efetuadas.
   
   Todas as análises foram programadas e executadas no editor
   #+begin_src emacs-lisp :exports results :results drawer
   (print (emacs-version))
   #+end_src

   #+RESULTS:
   :results:
   GNU Emacs 26.3 (build 2, x86_64-pc-linux-gnu, GTK+ Version 3.24.14)
	of 2020-03-26, modified by Debian
   :end:
   , fazendo uso do Org-mode, versão
   #+begin_src emacs-lisp :exports results :results drawer
   (print (org-version))
   #+end_src

   #+RESULTS:
   :results:
   9.4.4
   :end:
   .
   
** Dados brutos

   Os dados brutos são disponibilizados pelas pesquisadoras responsáveis pelo estudo, sendo as únicas com acesso às respostas.

   #+BEGIN_SRC R :exports code :results silent :session 
   raw <- read_csv(
	 file = './raw/[Piloto] Pesquisa Unicamp Surdos RMC 2021 (respostas) - Respostas ao formulário 1.csv'
   ) %>%
	 select(         # anonimização da base de dados
	   -c(3,5,6)     # ignora 'nome', 'celular' e 'email'
	 )
   #+END_SRC

   Municípios da Região Metropolitana de Campinas

   #+BEGIN_SRC R :exports code :results silent :session 
   ## Códigos de municípios do IBGE para as cidades da RMC
   rmc <- tribble(
	 ~municipio,                 ~codigo,
	 'AMERICANA',                3501608,
	 'AMPARO',                   3501905, # adesão ainda não oficial pela ALESP
	 'ARTUR NOGUEIRA',           3503802,
	 'CAMPINAS',                 3509502,
	 'COSMOPOLIS',               3512803,
	 'ENGENHEIRO COELHO',        3515152,
	 'HOLAMBRA',                 3519055,
	 'HORTOLANDIA',              3519071,
	 'INDAIATUBA',               3520509,
	 'ITATIBA',                  3523404,
	 'JAGUARIUNA',               3524709,
	 'MONTE MOR',                3531803,
	 'MORUNGABA',                3532009,
	 'NOVA ODESSA',              3533403,
	 'PAULINIA',                 3536505,
	 'PEDREIRA',                 3537107,
	 'SANTA BARBARA D OESTE',    3545803,
	 'SANTO ANTONIO DE POSSE',   3548005,
	 'SUMARE',                   3552403,
	 'VALINHOS',                 3556206,
	 'VINHEDO',                  3556701
   )
   #+END_SRC  
   
** Tratamento dos dados

   #+BEGIN_SRC R :exports code :results silent :session 
   ## renomeia as duas primeiras colunas para nomes mais curtos
   names(raw)[ c(1,2) ] <- c('data_preenchimento', 'consentimento')

   ## tabela de reclassificação dos nomes de coluna
   headers <- data.frame(
	 orig = names(raw)                        # nomes originais
	,codes = sprintf( 'V%03d', 1:ncol(raw) )  # novos nomes: V001 até V028
	,stringsAsFactors = FALSE
   ) 

   ## novos nomes de coluna
   names(raw) <- headers$codes

   ## tabela tratada
   dat <- raw %>%
	 transmute(
	   ## Data e hora de preenchimento do questionário
	   V001 = strptime( V001, format = '%d/%m/%Y %H:%M:%S' )
	   ## consentimento livre e esclarecido
	  ,V002
	   ## Você se comunica por LIBRAS, tem 18 anos ou mais e mora em alguma das cidades do mapa?
	  ,V003 = factor(
		 str_sub( string = V003, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Sim'
			,'B - Não'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Qual é a sua data de nascimento?
	  ,V004 = strptime( V004, format = '%d/%m/%Y' )
	   ## idade na data de preenchimento do questionário
	  ,V004_idade = as.numeric( round( ( V001 - V004 ) / 365.25, 0 ) )
	   ## Qual é o seu sexo?
	  ,V005 = factor(
		 str_sub( string = V005, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Feminino'
			,'B - Masculino'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Qual é a sua escolaridade?
	  ,V006 = factor(
		 str_sub( string = V006, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Nunca estudei'
			,'B - Fundamental (ou 1º grau)'
			,'C - Médio (ou 2º grau)'
			,'D - Superior (ou 3º grau)'
			,'E - Pós-graduação (especialização, mestrado, doutorado)'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Você trabalha?
	  ,V007 = factor(
		 str_sub( string = V007, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Sim, trabalho'
			,'B - Não trabalho e recebo benefício BPC/INSS'
			,'C - Não, porque sou aposentado'
			,'D - Não, porque sou estudante'
			,'E - Não, estou desempregado'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Qual é a sua cor (ou raça)?
	  ,V008 = factor(
		 str_sub( string = V008, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Preta'
			,'B - Branca'
			,'C - Parda'
			,'D - Indígena'
			,'E - Amarela'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Qual sua religião?
	  ,V009 = ifelse(
		 grepl( ' - ', V009, ignore.case = TRUE)
		,str_sub( string = V009, start = 5 )
		,V009
	   )
	   ## Qual cidade você mora?
	  ,V010 = toupper( iconv(V010, from = "UTF-8", "ASCII//TRANSLIT") )
	  ,V010 = gsub( '/',' ', V010)
	  ,V010 = gsub( ' - ',' ', V010)
	  ,V010 = gsub( '-',' ', V010)
	  ,V010 = gsub( "'",' ', V010)
	  ,V010 = gsub( ' SP','', V010)
	  ,V010_rmc = ifelse( V010 %in% rmc$municipio, TRUE, FALSE)
	   ## Qual bairro você mora?
	  ,V011
	   ## Qual número do seu CEP?
	  ,V012 = gsub('[[:blank:]]+','', gsub('[[:punct:]]+',' ',V012) )
	   ## Você tem diabetes?
	  ,V013 = factor(
		 str_sub( string = V013, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Sim e faço tratamento com remédios'
			,'B - Sim, mas não faço tratamento com remédios'
			,'C - Não tenho'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Você tem pressão alta?
	  ,V014 = factor(
		 str_sub( string = V014, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Sim e faço tratamento com remédios'
			,'B - Sim, mas não faço tratamento com remédios'
			,'C - Não tenho'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Qual é a sua opinião sobre sua saúde?
	  ,V015 = factor(
		 str_sub( string = V015, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Muito boa'
			,'B - Boa'
			,'C - Regular'
			,'D - Ruim'
			,'E - Muito ruim'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Você fuma?
	  ,V016 = factor(
		 str_sub( string = V016, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Sim, todos os dias'
			,'B - Sim, às vezes'
			,'C - Não'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Você toma bebidas alcoólicas?
	  ,V017 = factor(
		 str_sub( string = V017, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Sim, todos os dias'
			,'B - Sim, às vezes'
			,'C - Não'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Você usa os serviços de saúde do SUS, por exemplo, centros de saúde, hospitais, exames e vários outros serviços de saúde?
	  ,V018 = factor(
		 str_sub( string = V018, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Sim'
			,'B - Não'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Quando você vai aos serviços de saúde do SUS como você avalia a comunicação com médicos, enfermeiros e diversos profissionais nestes serviços?
	  ,V019 = factor(
		 str_sub( string = V019, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Ruim, não sabem LIBRAS e sou obrigado a oralizar'
			,'B - Ruim, não sabem LIBRAS e preciso escrever português'
			,'C - Ruim, não consigo comunicação'
			,'D - Boa, tem intérprete que me ajuda'
			,'E - Boa, porque familiar me ajuda'
			,'F - Boa, o profissional de saúde sabe LIBRAS'
		   )
		  ,start = 5
		 ) 
	   )
	   ## O intérprete da Central de Interpretação de Libras (CIL) vai no atendimento com você no serviço público de saúde SUS?
	  ,V020 = factor(
		 str_sub( string = V020, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Sim'
			,'B - Não, porque eu esqueço de pedir'
			,'C - Não, porque não tem intérprete livre nunca'
			,'D - Não, porque não tem na minha cidade'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Você usa a rede particular de saúde? Exemplo: hospital, médico, convênio
	  ,V021 = factor(
		 str_sub( string = V021, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Sim'
			,'B - Não'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Como você avalia a comunicação entre você e o profissional de saúde do convênio ou na rede particular, com médicos, enfermeiros e diversos outros profissionais, como é a comunicação?
	  ,V022 = factor(
		 str_sub( string = V022, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Ruim, não sabem LIBRAS e sou obrigado a oralizar'
			,'B - Ruim, não sabem LIBRAS e preciso escrever português'
			,'C - Ruim, não consigo comunicação'
			,'D - Boa, tem intérprete que me ajuda'
			,'E - Boa, porque familiar me ajuda'
			,'F - Boa, o profissional de saúde sabe LIBRAS'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Você usa aparelho auditivo?
	  ,V023 = factor(
		 str_sub( string = V023, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Sim'
			,'B - Não'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Você conseguiu seu aparelho auditivo pelo SUS?
	  ,V024 = factor(
		 str_sub( string = V024, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Sim'
			,'B - Não'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Como você avalia a comunicação entre você e o médico, a fonoaudióloga e os diversos outros profissionais do centro do SUS onde conseguiu o aparelho auditivo?
	  ,V025 = factor(
		 str_sub( string = V025, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Ruim, não sabe LIBRAS e sou obrigado a oralizar'
			,'B - Ruim, não sabe LIBRAS e preciso escrever português'
			,'C - Ruim, não consigo comunicação'
			,'D - Boa, tem intérprete que me ajuda'
			,'E - Boa, porque familiar me ajuda'
			,'F - Boa, o profissional de saúde sabe LIBRAS'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Você usa implante coclear?
	  ,V026 = factor(
		 str_sub( string = V026, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Sim'
			,'B - Não'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Você conseguiu seu implante coclear pelo SUS?
	  ,V027 = factor(
		 str_sub( string = V027, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Sim'
			,'B - Não'
		   )
		  ,start = 5
		 ) 
	   )
	   ## Como você avalia a comunicação entre você e o médico, a fonoaudióloga e os diversos outros profissionais do centro do SUS onde conseguiu o implante coclear?
	  ,V028 = factor(
		 str_sub( string = V028, start = 5 )
		,levels = str_sub(
		   c(
			 'A - Ruim, não sabe LIBRAS e sou obrigado a oralizar'
			,'B - Ruim, não sabe LIBRAS e preciso escrever português'
			,'C - Ruim, não consigo comunicação'
			,'D - Boa, tem intérprete que me ajuda'
			,'E - Boa, porque familiar me ajuda'
			,'F - Boa, o profissional de saúde sabe LIBRAS'
		   )
		  ,start = 5
		 ) 
	   )
	   ## flag de respostas válidas
	  ,VALIDA = case_when(
		 ## Preenchimento   correto para 'Consentimento' e   correto para 'Público Alvo'
		 !is.na(V002) & V003 == 'Sim' & ( V004_idade >= 18 | is.na(V004_idade) ) & ( V010_rmc == TRUE | is.na(V010) ) ~ TRUE
		 ## Preenchimento   correto para 'Consentimento' e incorreto para 'Público Alvo'
		,!is.na(V002) & V003 != 'Sim' & ( V004_idade >= 18 | is.na(V004_idade) ) & ( V010_rmc == TRUE | is.na(V010) ) ~ TRUE
		 ## Preenchimento incorreto para 'Consentimento' e   correto para 'Público Alvo'
		,is.na(V002)  & V003 == 'Sim' & ( V004_idade >= 18 | is.na(V004_idade) ) & ( V010_rmc == TRUE | is.na(V010) ) ~ TRUE
		 ## Preenchimento incorreto para 'Consentimento' e incorreto para 'Público Alvo'
		,is.na(V002)  & V003 != 'Sim' & ( V004_idade >= 18 | is.na(V004_idade) ) & ( V010_rmc == TRUE               ) ~ TRUE
	   )
	 )

   ## validação da lógica...
   ## dat %>% select( V002, V003, V004_idade, V010_rmc, V010, VALIDA) %>% View
   ## dat %>% select( V002, V003, V004_idade, V010_rmc, V010, VALIDA) %>% filter( is.na(VALIDA) ) %>% View

   ## dat %>% filter( is.na(V002), !is.na(VALIDA) ) %>% select( V002, V003, V004_idade, V010_rmc, V010, VALIDA) %>% View

   write_csv2(
	 dat
	,file = './data/respostas_tratadas.csv'
   )

   #+END_SRC

** Exporta dados tratados no formato apropriado ao SPSS

   #+BEGIN_SRC R :exports code :results silent :session 
   write_sav(
	 data = dat
	,path = './spss/dados_spss.sav'
   )
   #+END_SRC
   

* Análise exploratória de dados

** Evolução do número de repostas
   
*** Totais
	#+BEGIN_SRC R :exports none :results silent :session 
	## evolução cumulativa do número de respostas
	evol <- data.frame(
	  V001 = seq(
		from = as.Date( min(dat$V001) )
	   ,to = Sys.Date()
	   ,by = 'days'
	  )
	) %>%
	  left_join( dat %>% mutate( V001 = as.Date(V001) ) %>% count(V001) ) %>%
	  replace( is.na(.), 0 ) %>%   # https://stackoverflow.com/a/60941799
	  mutate( c = cumsum(n) )

	## Gráfico da evolução do número de respostas
	alvo <- 400
	evol_plot <- evol %>%
	  ggplot( aes( x = V001, y = c) ) +
	  geom_line() +
	  geom_point() +
	  ylim(0, alvo * 1.1 ) +
	  xlim( evol[1,1], as.Date( '2021-10-01') ) + 
	  geom_hline( yintercept = alvo, linetype = 'longdash', col='red') +
	  geom_text(
		x = evol[1,1]
	   ,y = alvo + 15
	   ,label = 'Expectativa do número de respostas'
	   ,col = 'red'
	   ,hjust = 0
	  ) +
	  geom_text(
		x = evol[ nrow(evol), 1]
	   ,y = evol[ nrow(evol), 3]
	   ,fontface = 'italic'
	   ,hjust = -0.1
	   ,label = paste0(
		  evol[ nrow(evol), 3]
		 ,' respostas até '
		 ,format( evol[ nrow(evol), 1], '%d.%m.%Y' )
		)
	  ) + 
	  theme_bw() +
	  labs(
		x = 'dia'
	   ,y = 'número acumulado de respostas'
	   ,title = 'Pesquisa Unicamp Surdos RMC 2021'
	   ,subtitle = 'Evolução do número acumulado de respostas por dia'
	   ,caption = paste(
		  'Obs.: Dados atualizados até'
		 ,format( Sys.time(), '%d.%m.%Y %H:%M:%S' )
		)
	  )

	ggsave( plot = evol_plot, filename = './img/evol_plot.png', width=6, height=4)
	#+END_SRC

	#+CAPTION: Evolução do número acumulado de respostas por dia
	#+ATTR_ORG: :width 600
	[[./img/evol_plot.png]]

*** Válidas
	#+BEGIN_SRC R :exports none :results silent :session 
	## evolução cumulativa do número de respostas
	valid <- data.frame(
	  V001 = seq(
		from = as.Date( min(dat$V001) )
	   ,to = Sys.Date()
	   ,by = 'days'
	  )
	) %>%
	  left_join( dat %>% filter( !is.na(VALIDA) ) %>% mutate( V001 = as.Date(V001) ) %>% count(V001) ) %>%
	  replace( is.na(.), 0 ) %>%   # https://stackoverflow.com/a/60941799
	  mutate( c = cumsum(n) )

	## Gráfico da evolução do número de respostas
	alvo <- 400
	valid_plot <- valid %>%
	  ggplot( aes( x = V001, y = c) ) +
	  geom_line() +
	  geom_point() +
	  ylim(0, alvo * 1.1 ) +
	  xlim( valid[1,1], as.Date( '2021-10-01') ) + 
	  geom_hline( yintercept = alvo, linetype = 'longdash', col='red') +
	  geom_text(
		x = valid[1,1]
	   ,y = alvo + 15
	   ,label = 'Expectativa do número de respostas válidas'
	   ,col = 'red'
	   ,hjust = 0
	  ) +
	  geom_text(
		x = valid[ nrow(valid), 1]
	   ,y = valid[ nrow(valid), 3]
	   ,fontface = 'italic'
	   ,hjust = -0.1
	   ,label = paste0(
		  valid[ nrow(valid), 3]
		 ,' respostas válidas até '
		 ,format( valid[ nrow(valid), 1], '%d.%m.%Y' )
		)
	  ) + 
	  theme_bw() +
	  labs(
		x = 'dia'
	   ,y = 'número acumulado de respostas válidas'
	   ,title = 'Pesquisa Unicamp Surdos RMC 2021'
	   ,subtitle = 'Validução do número acumulado de respostas válidas por dia'
	   ,caption = paste(
		  'Obs.: Dados atualizados até'
		 ,format( Sys.time(), '%d.%m.%Y %H:%M:%S' )
		)
	  )

	ggsave( plot = valid_plot, filename = './img/valid_plot.png', width=6, height=4)
	#+END_SRC

	#+CAPTION: Evolução do número acumulado de respostas por dia
	#+ATTR_ORG: :width 600
	[[./img/valid_plot.png]]

	
** Perfil dos participantes
   
   Até o momento src_R[:session :results replace ]{ nrow(dat)} {{{results(=88=)}}}  pessoas participaram da pesquisa, provenientes das seguintes cidades

   #+BEGIN_SRC R :exports results :results table :colnames yes :session 
   ## cidade
   dat %>%
	 count( V010, sort = TRUE) %>%
	 mutate( f = round( n/sum(n), digits = 3) ) %>% 
	 bind_rows(
	   .
	  ,data.frame( V010 = 'RESPOSTAS', n=nrow(dat), f=1 )
	 )
   #+END_SRC

   #+RESULTS:
   | V010                  |  n |     f |
   |-----------------------+----+-------|
   | CAMPINAS              | 36 | 0.409 |
   | HORTOLANDIA           | 10 | 0.114 |
   | SUMARE                |  7 |  0.08 |
   | PAULINIA              |  6 | 0.068 |
   | VALINHOS              |  5 | 0.057 |
   | nil                   |  4 | 0.045 |
   | JAGUARIUNA            |  3 | 0.034 |
   | INDAIATUBA            |  2 | 0.023 |
   | NOVA ODESSA           |  2 | 0.023 |
   | SANTA BARBARA D OESTE |  2 | 0.023 |
   | AMERICANA             |  1 | 0.011 |
   | AMPARO                |  1 | 0.011 |
   | CACHOEIRA DE MINAS MG |  1 | 0.011 |
   | CAMPINAA              |  1 | 0.011 |
   | CAPIVARI              |  1 | 0.011 |
   | COSMOPOLIS            |  1 | 0.011 |
   | IRACEMAPOLIS          |  1 | 0.011 |
   | JUNDIAI               |  1 | 0.011 |
   | POCOS DE CALDAS       |  1 | 0.011 |
   | SALTO                 |  1 | 0.011 |
   | SAO JOSE DO RIO PARDO |  1 | 0.011 |
   | RESPOSTAS             | 88 |     1 |

   Dos quais até o momento src_R[:session :results replace ]{ nrow(dat %>% filter( !is.na(VALIDA)))} {{{results(=76=)}}}  participantes pertencem ao público alvo da pesquisa, provenientes das seguintes cidades

   #+BEGIN_SRC R :exports results :results table :colnames yes :session 
   ## cidade
   dat %>%
	 filter( !is.na(VALIDA) ) %>%
	 count( V010, sort = TRUE) %>%
	 mutate( f = round( n/sum(n), digits = 3) ) %>% 
	 bind_rows(
	   .
	  ,data.frame(
		 V010 = 'RESPOSTAS'
		,n = nrow( dat %>% filter(!is.na(VALIDA)) )
		,f=1
	   )
	 )
   #+END_SRC

   #+RESULTS:
   | V010                  |  n |     f |
   |-----------------------+----+-------|
   | CAMPINAS              | 35 | 0.461 |
   | HORTOLANDIA           |  9 | 0.118 |
   | SUMARE                |  7 | 0.092 |
   | PAULINIA              |  6 | 0.079 |
   | VALINHOS              |  5 | 0.066 |
   | JAGUARIUNA            |  3 | 0.039 |
   | INDAIATUBA            |  2 | 0.026 |
   | NOVA ODESSA           |  2 | 0.026 |
   | SANTA BARBARA D OESTE |  2 | 0.026 |
   | nil                   |  2 | 0.026 |
   | AMERICANA             |  1 | 0.013 |
   | AMPARO                |  1 | 0.013 |
   | COSMOPOLIS            |  1 | 0.013 |
   | RESPOSTAS             | 76 |     1 |

   #+BEGIN_SRC R :exports none :results silent :session 
   ## Perfil dos respondentes válidos

   ## idade média
   v004 <- dat %>% filter(!is.na(VALIDA)) %>% summarize( avg = mean(V004_idade, na.rm = TRUE) )
   ## sexo
   v005 <- dat %>% filter(!is.na(VALIDA)) %>% count( V005, sort = TRUE) %>% mutate( p = n/sum(n) )
   ## escolaridade
   v006 <- dat %>% filter(!is.na(VALIDA)) %>% count( V006) %>% mutate( p = round( n/sum(n), 3) )
   ## auto-avaliação do estado de saúde
   v015 <- dat %>% filter(!is.na(VALIDA)) %>% count( V015) %>% mutate( p = round( n/sum(n), 3) )
   #+END_SRC

   Perfil dos participantes:

   - idade média de src_R[:session :results replace ]{ round( v004,1) } {{{results(=39.8=)}}} anos
   - src_R[:session :results replace ]{ round( v005[1,3]*100,1) } {{{results(=55.3=)}}} % do sexo src_R[:session :results replace ]{ v005[1,1] } {{{results(=Feminino=)}}}
   - src_R[:session :results replace ]{ 100*sum( v006[ c(4,5), 'p'] ) } {{{results(=61.9=)}}} % com ensino superior ou pós-graduação
   - src_R[:session :results replace ]{ 100*sum( v015[ c(1,2), 'p'] ) } {{{results(=76.3=)}}} % avaliam seu estado de saúde como bom ou muito bom


* Matriz de distâncias
  
  #+BEGIN_SRC R :exports none :results silent :session 
  ## Download dos estabelecimentos do SUS
  ##download.file(url = 'ftp.datasus.gov.br/cnes/BASE_DE_DADOS_CNES_202107.ZIP', destfile = '/tmp/BASE_DE_DADOS_CNES_202107.ZIP', method = 'curl')

  unzip(
	zipfile = '/tmp/BASE_DE_DADOS_CNES_202107.ZIP'
   ,files = c(
	  'tbEstabelecimento202107.csv'
	 ,'tbNaturezaJuridica202107.csv'
	 ,'tbTipoEstabelecimento202107.csv'
	)
   ,exdir = '/tmp/'
  )

  cnes    <- read_csv2(file = '/tmp/tbEstabelecimento202107.csv')
  natjur  <- read_csv2(file = '/tmp/tbNaturezaJuridica202107.csv')
  estab   <- read_csv2(file = '/tmp/tbTipoEstabelecimento202107.csv')

  estab_lista <- cnes %>%
	transmute(
	  CO_CNES
	 ,CO_CEP
	 ,CO_NATUREZA_JUR
	 ,CO_TIPO_ESTABELECIMENTO
	 ,CO_MUNICIPIO_GESTOR
	 ,NU_LATITUDE
	 ,NU_LONGITUDE
	) %>% 
	left_join(
	  rmc %>%
	  transmute(
		MUNICIPIO = municipio
	   ,CO_MUNICIPIO_GESTOR = as.numeric( str_sub( codigo, end=-2) )
	  )
	) %>%
	na.omit() %>%
	left_join( 
	  estab %>%
	  select(CO_TIPO_ESTABELECIMENTO, DS_TIPO_ESTABELECIMENTO) %>%
	  filter( CO_TIPO_ESTABELECIMENTO %in% c('001','006') ) # UBS e Hospitais somente...
	) %>% 
	na.omit() %>%
	left_join(
	  natjur
	) %>% 
	select( -CO_NATUREZA_JUR, -CO_TIPO_ESTABELECIMENTO)

  write_csv2(
	estab_lista
   ,file = './data/estab_lista.csv'
  )

  ## estab_lista %>%
  ## count( MUNICIPIO, DS_TIPO_ESTABELECIMENTO) %>% 
  ##   pivot_wider(
  ## 	id_cols = MUNICIPIO
  ##    ,names_from = DS_TIPO_ESTABELECIMENTO
  ##    ,values_from = n
  ##    ,values_fill = 0
  ##   ) %>% View

  ## estab_lista %>%
  ## count( DS_TIPO_ESTABELECIMENTO, DS_NATUREZA_JUR) %>% 
  ##   pivot_wider(
  ## 	id_cols = DS_NATUREZA_JUR
  ##    ,names_from = DS_TIPO_ESTABELECIMENTO
  ##    ,values_from = n
  ##    ,values_fill = 0
  ##   ) %>% View

  ## estab_lista %>%
  ## count( MUNICIPIO, DS_NATUREZA_JUR, DS_TIPO_ESTABELECIMENTO) %>% 
  ##   pivot_wider(
  ## 	id_cols = c(MUNICIPIO, DS_NATUREZA_JUR)
  ##    ,names_from = DS_TIPO_ESTABELECIMENTO
  ##    ,values_from = n
  ##    ,values_fill = 0
  ##   ) %>% View
  #+END_SRC  

  Os estabelecimentos do SUS estão disponíveis no link ftp://ftp.datasus.gov.br/cnes/BASE_DE_DADOS_CNES_202107.ZIP, do qual serão utilizados somente os arquivos
  - =tbEstabelecimento202107.csv=
  - =tbNaturezaJuridica202107.csv= e
  - =tbTipoEstabelecimento202107.csv=.

	A tabela =tbEstabelecimento202107= contém a listagem do CNES referente a Julho de 2021; dela serão utilizados, para fins da pesquisa da Unicamp Surdos RMC 2021, os campos
  - =CO_CNES=, o código CNES do estabelecimento do SUS
  - =CO_CEP=, o CEP do estabelecimento para ser utilizado no cálculo da matriz de distâncias
  - =CO_NATUREZA_JUR=, código da natureza jurídica, a ser relacionado com a tabela =tbNaturezaJuridica202107.csv=
  - =CO_TIPO_ESTABELECIMENTO=, tipo de estabelecimento, a ser relacionado com a tabela =tbTipoEstabelecimento202107.csv=
  - =CO_MUNICIPIO_GESTOR=, o código do município do IBGE
  - =NU_LATITUDE=, latitude (em graus) para gráfico/georeferenciamento
  - e =NU_LONGITUDE=, longitude (em graus) para gráfico/georeferenciamento

  
